const canvas=document.querySelector('canvas'),context=canvas.getContext('2d'),body=document.querySelector('body'),width=800,height=600;canvas.width=width,canvas.height=height;let inBlock='menu',question='',answer='',setIntervalForGame=null,PosHeroX=200;const PosHeroY=389;let PosEnemyX=600;const PosEnemyY=419;let trueAnswer=null,goAttack=null,moveAction=!1,dieBool=!1;const data=[{gold:6,enemyHp:6,enemyAtc:2,task:['4 - 4','1 + 3','3 - 1','1 + 1','4 - 3','8 + 2','10 - 2','3 - 2']},{gold:12,enemyHp:12,enemyAtc:4,task:['18 + 18','16 + 13 - 7','25 - 14','40 - 29','23 + 8']},{gold:24,enemyHp:24,enemyAtc:8,task:['33 + 0 + 7','25 - 15 + 10','40 - 18','15 + 5 + 5','29 * 2']},{gold:32,enemyHp:48,enemyAtc:12,task:['42 * 3','280 / 2','2 + 2 + 2 + 2 - 2 * 2','38 / 2','720 / 18']}];let classIter=localStorage.classIter&&localStorage.classIter<=data.length?JSON.parse(localStorage.classIter):0,lvlIter=0,mark=0,gold=localStorage.gold?JSON.parse(localStorage.gold):0;function Persons(a,b,d,f,g,j){this.hp=g,this.fullHP=this.hp,this.atk=j,this.img=loadImage(a,b,d,f)}Persons.prototype.setHP=function(a){this.hp=a,this.fullHP=a},Persons.prototype.setAtk=function(a){this.atk=a};const hero=creatHero(),enemy=new Persons('./img/enemies/1.png',95,64,4,data[classIter].enemyHp,data[classIter].enemyAtc);enemy.gold=data[classIter].gold,enemy.imgCount=1;function creatHero(){let a=localStorage.heroFullHP?JSON.parse(localStorage.heroFullHP):3,b=localStorage.heroAtk?JSON.parse(localStorage.heroAtk):1;return new Persons('./img/heroes/1.png',74,96,10,a,b)}canvas.onclick=function(a){const b=getMousePos(a);'menu'==inBlock&&(250<b.x&&550>b.x&&(150<b.y&&220>b.y&&(inBlock='game',startGame(0)),275<b.y&&345>b.y&&(inBlock='game',startGame(1)),400<b.y&&470>b.y&&(inBlock='shop',shop())),0<b.x&&68>b.x&&486<b.y&&557>b.y&&('stop'===music.state?music.play():music.stop())),'shop'==inBlock&&374<b.y&&405>b.y&&(140<b.x&&271>b.x&&upHphero(),520<b.x&&650>b.x&&upAtkhero())},body.onkeydown=function(a){if(27===a.keyCode&&(inBlock='menu',drawMenu(),clearTimeout(setIntervalForGame),save()),'game'==inBlock&&!moveAction)switch(a.keyCode){case 13:''!=answer&&checkAnswer();;break;case 8:answer=answer.substring(0,answer.length-1);;break;case 48:addNumberToAns(0);;break;case 97:case 49:addNumberToAns(1);;break;case 98:case 50:addNumberToAns(2);;break;case 99:case 51:addNumberToAns(3);;break;case 100:case 52:addNumberToAns(4);;break;case 101:case 53:addNumberToAns(5);;break;case 102:case 54:addNumberToAns(6);;break;case 103:case 55:addNumberToAns(7);;break;case 104:case 56:addNumberToAns(8);;break;case 105:case 57:addNumberToAns(9);;break;case 108:case 188:case 190:case 191:addNumberToAns('.');;}};function getMousePos(a){let b=canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}}function fillRect(a,b,d,f){context.fillRect(a,b,d,f)}function strokeRect(a,b,d,f){context.strokeRect(a,b,d,f)}function drawMenu(){function a(){context.drawImage(b,0,0),context.strokeStyle='#00007F',context.fillStyle='#4C8BFF',context.fillRect(250,150,300,70),context.strokeRect(250,150,300,70),context.fillRect(250,275,300,70),context.strokeRect(250,275,300,70),context.fillRect(250,400,300,70),context.strokeRect(250,400,300,70),context.font='50px Arial',context.fillStyle='white',context.fillText('New game',280,200),context.fillText('Continue',300,327),context.fillText('Shop',345,453)}inBlock='menu';let b=new Image;b.onload=function(){a()},b.src='./img/clouds1.png'}function drawAnswerTrue(){function a(){context.drawImage(b,0,0),context.font='50px Arial',context.fillStyle='white',context.fillText('You answered correctly',160,227),context.fillText(`on ${mark} examples of ${data.reduce((d,f)=>d+f.task.length,0)}`,200,297),context.font='30px Arial',context.fillText('Press ESC to enter the menu',200,597)}clearTimeout(setIntervalForGame);let b=new Image;b.onload=function(){a()},b.src='./img/sky.png'}function drawGame(){function a(){context.drawImage(b,0,0),showStuts(),writeLvlInfo(),drawBlockQuestion(),writeTextInBlock(),drawMessageBlock(),!0===trueAnswer?heroGoAttack():!1===trueAnswer?enemyGoAttack():(heroStop(),enemyStop())}if(classIter===data.length)return void drawAnswerTrue();question=data[classIter].task[lvlIter];let b=new Image;b.onload=function(){a()},b.src='./img/BG3.png'}function drawBlockQuestion(){let a='rgba(42, 252, 255, 0.78)';trueAnswer?a='green':!1===trueAnswer&&(a='red'),context.strokeStyle=a,context.fillStyle='rgba(255, 255, 255, .58)',context.fillRect(220,90,400,70),context.strokeRect(220,90,400,70)}function writeTextInBlock(){context.font='24px Arial',context.fillStyle='#3FBDBD',context.fillText(`${question} = ${answer}`,250,135)}function drawMessageBlock(){context.strokeStyle='rgba(99, 57, 27, 1.0)',context.fillStyle='rgba(175, 100, 46, .7)',context.fillRect(220,500,400,70),context.strokeRect(220,500,400,70),enterTextFromMessage()}function enterTextFromMessage(){let a='',b=240;null==trueAnswer?a='Heroes are waiting for an answer':trueAnswer?(a='Your answer is correct',b=300):(a='Your answer is incorrect',b=300),drawMessageText(a,b)}function drawMessageText(a,b){context.font='24px Arial',context.fillStyle='#EC9',context.fillText(a,b,545)}function writeLvlInfo(){context.font='15px Arial',context.fillStyle='#66BCB2',context.fillText(`lvl ${classIter+1}.${lvlIter+1}`,380,20)}function showStuts(){context.font='16px Arial',context.fillStyle='#00BC06',context.fillText(`HP ${hero.hp}`,10,20),context.fillText(`ATK ${hero.atk}`,10,40),context.fillText(`Gold ${gold}`,10,60),context.font='16px Arial',context.fillStyle='#BC1F1F';let a='';a=`${0>enemy.hp?0:enemy.hp} HP`,context.fillText(a,800-10*a.length,20),a=`${enemy.atk} ATK`,context.fillText(a,800-10*a.length,40)}function addNumberToAns(a){9<answer.length||(answer+=a)}function checkAnswer(){trueAnswer=eval(question)===eval(answer),goAttack=1}function startGame(a){inBlock='game',answer='',setIntervalForGame=setInterval(function(){drawGame()},90),a?classIter<data.length&&localStorage.heroHp&&0<localStorage.heroHp?(lvlIter=JSON.parse(localStorage.lvlIter),mark=JSON.parse(localStorage.mark),hero.hp=JSON.parse(localStorage.heroHp),enemy.hp=0<localStorage.enemyHp?JSON.parse(localStorage.enemyHp):enemy.fullHP,enemy.atk=JSON.parse(localStorage.enemyATK),enemy.imgCount=JSON.parse(localStorage.enemySkin),enemy.img=loadImage(`./img/enemies/${enemy.imgCount}.png`,95,64,4)):newGame():newGame(),drawGame()}function newGame(){classIter=0,lvlIter=0,mark=0,hero.hp=hero.fullHP,enemy.setHP(data[classIter].enemyHp),enemy.setAtk(data[classIter].enemyAtc),enemy.gold=data[classIter].gold,enemy.img=loadImage('./img/enemies/1.png',95,64,4),enemy.imgCount=1}function loadImage(a,b,d,f){const g=document.createElement('img'),j={dom:g,width:b,height:d,count:f,loaded:!1,num:0};return g.onload=function(){j.loaded=!0},g.src=a,j}function drawImage(a,b,d,f,g){if(a.loaded){let k=0;'hero'===g&&(checkHeroType(a,f),k=60),'enemy'===g&&(checkEnemyType(a,f),k=30),context.drawImage(a.dom,a.width*(a.num-1),0,a.width,a.height,b,d,45,k)}}function checkHeroType(a,b){1===b&&(a.num=6),2===b&&(a.num>=a.count-1?a.num=6:a.num+=1),3===b&&(a.num=10),4===b&&(a.num>=a.count-6?a.num=1:a.num+=1)}function checkEnemyType(a,b){1===b&&(a.num=3),2===b&&(a.num>=a.count-1?a.num=2:a.num+=1),3===b&&(a.num=1),4===b&&(a.num>=a.count+1?a.num=4:a.num+=1)}function heroMove(){drawImage(hero.img,PosHeroX,PosHeroY,2,'hero')}function heroAttack(){drawImage(hero.img,PosHeroX,PosHeroY,3,'hero')}function heroBack(){drawImage(hero.img,PosHeroX,PosHeroY,4,'hero')}function heroStop(){drawImage(hero.img,PosHeroX,PosHeroY,1,'hero')}function heroGoAttack(){goAttack?(moveAction=!0,PosHeroX<=PosEnemyX-50?(PosHeroX+=10,heroMove(),enemyStop()):PosHeroX==PosEnemyX-40&&(heroAttack(),enemyStop(),goAttack=0,dieBool=!0)):!goAttack&&200<=PosHeroX&&(heroBack(),PosHeroX-=10,dieBool?(enemy.hp-=hero.atk,dieBool=!1):0<enemy.hp&&enemyStop(),200==PosHeroX&&(goAttack=null,trueAnswer=null,mark+=1,moveAction=!1,enemyDied(),nextQuestion()))}function enemyDied(){if(!(0<enemy.hp)){addGold();let a=data[classIter].enemyHp,b=data[classIter].enemyAtc,d=data[classIter].gold,f=Math.floor(Math.random()*(a-a/3))+a/3,g=classIter?Math.floor(Math.random()*(b-b/2))+b/2:Math.floor(Math.random()*b)+b/2;changeEnemySkin(),enemy.setHP(f),enemy.setAtk(g),enemy.gold=Math.floor(Math.random()*(d+5-(d-5)))+(d-5)}}function enemyMove(){drawImage(enemy.img,PosEnemyX,PosEnemyY,2,'enemy')}function enemyAttack(){drawImage(enemy.img,PosEnemyX,PosEnemyY,3,'enemy')}function enemyBack(){drawImage(enemy.img,PosEnemyX,PosEnemyY,4,'enemy')}function enemyStop(){drawImage(enemy.img,PosEnemyX,PosEnemyY,1,'enemy')}function enemyGoAttack(){goAttack?(moveAction=!0,PosEnemyX>=PosHeroX+50?(PosEnemyX-=10,enemyMove(),heroStop()):PosEnemyX==PosHeroX+40&&(enemyAttack(),heroStop(),goAttack=0,dieBool=!0)):!goAttack&&600>=PosEnemyX&&(enemyBack(),PosEnemyX+=10,dieBool?(hero.hp-=enemy.atk,dieBool=!1):0<hero.hp&&heroStop(),600==PosEnemyX&&(goAttack=null,trueAnswer=null,moveAction=!1,attackOnHero(),nextQuestion()))}function attackOnHero(){0>=hero.hp&&heroDied()}function nextQuestion(){lvlIter===data[classIter].task.length-1?(classIter++,lvlIter=0):lvlIter++,answer=''}function changeEnemySkin(){enemy.imgCount=Math.floor(Math.random()*4)+1,enemy.img=loadImage(`./img/enemies/${enemy.imgCount}.png`,95,64,4)}function heroDied(){function a(){context.drawImage(b,0,0),context.font='50px Arial',context.fillStyle='white',context.fillText('Game over',280,305),context.font='30px Arial',context.fillText('Press ESC to enter the menu',200,597)}clearTimeout(setIntervalForGame);let b=new Image;b.onload=function(){a()},b.src='./img/sky.png'}function addGold(){gold+=enemy.gold}function save(){localStorage.classIter=classIter,localStorage.lvlIter=lvlIter,localStorage.mark=mark,localStorage.gold=gold,localStorage.heroHp=hero.hp,localStorage.enemyHp=enemy.hp,localStorage.enemyATK=enemy.atk,localStorage.enemySkin=enemy.imgCount}function shop(){setIntervalForGame=setInterval(function(){drawShop()},90)}function drawShop(){function a(){context.drawImage(b,0,0),context.font='24px Arial',context.fillStyle='white',context.fillText(`Gold - ${gold}`,340,110),context.font='30px Arial',context.fillText('HP',190,204),context.fillText('ATK',560,204),context.font='18px Arial',context.fillText(`Current HP - ${hero.fullHP}`,100,231),context.fillText(`HP after upgrade - ${hero.fullHP+1}`,100,261),context.fillText(`Cost - ${costHpHpHero()} gold`,100,288),context.fillText(`upgrade`,174,393),context.fillText(`Current ATK - ${hero.atk}`,480,231),context.fillText(`ATK after upgrade - ${hero.atk+1}`,480,261),context.fillText(`Cost - ${costAtkHpHero()} gold`,480,288),context.fillText(`upgrade`,554,393),context.font='30px Arial',context.fillText('Press ESC to enter the menu',200,597)}let b=new Image;b.onload=function(){a()},b.src='./img/shop.png'}function costHpHpHero(){return 11>hero.fullHP+1?2*hero.fullHP:3*hero.fullHP}function costAtkHpHero(){return 6>hero.atk+1?2*hero.atk:12>hero.atk+1?3*hero.atk:5*hero.atk}function upHphero(){gold>=costHpHpHero()&&(gold-=costHpHpHero(),hero.fullHP+=1,localStorage.heroFullHP=hero.fullHP)}function upAtkhero(){gold>=costAtkHpHero()&&(gold-=costAtkHpHero(),hero.atk+=1,localStorage.heroAtk=hero.atk)}function loadAudio(a,b){const d=document.createElement('audio');for(var g,f=0;f<a.length;f++)g=document.createElement('source'),g.src=a[f],d.appendChild(g);d.volume=b||1;return{dom:null,state:'stop',play:function(){this.dom.play(),this.state='play'},stop:function(){this.dom.pause(),this.dom.currentTime=0,this.state='stop'},dom:d}}const music=loadAudio(['./music/bit.mp3'],0.3);music.play(),music.dom.addEventListener('ended',function(){this.currentTime=0,this.play()},!1),drawMenu();